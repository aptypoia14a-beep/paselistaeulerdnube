<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia Escolar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }

        .cloud-status {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .cloud-status.disconnected {
            background: #ffebee;
            border-color: #f44336;
        }

        .cloud-status.syncing {
            background: #fff3e0;
            border-color: #ff9800;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .status-box.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-box.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status-box.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .student-card h3 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .student-card p {
            color: #666;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .actions {
            text-align: center;
            margin-top: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .manual-entry {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .config-section {
            background: #fff9e6;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .backup-section {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .backup-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 12px 30px;
            background: #2196f3;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
        }

        .file-input-label:hover {
            background: #1976d2;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Sistema de Asistencia</h1>
        <p class="subtitle">Control de entrada y salida con QR/C√≥digo de Barras - ‚òÅÔ∏è Sincronizado con Google Sheets</p>
        
        <div id="cloudStatus" class="cloud-status disconnected">
            ‚ö†Ô∏è No conectado a Google Sheets - Usando almacenamiento local
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('scanner')">üîç Esc√°ner</button>
            <button class="tab" onclick="showTab('students')">üë• Alumnos</button>
            <button class="tab" onclick="showTab('records')">üìä Registros</button>
            <button class="tab" onclick="showTab('reports')">üìà Reportes</button>
            <button class="tab" onclick="showTab('config')">‚öôÔ∏è Configuraci√≥n</button>
        </div>
        
        <!-- TAB: CONFIGURACI√ìN -->
        <div id="config" class="tab-content">
            <h2>‚öôÔ∏è Configuraci√≥n de Google Sheets</h2>
            
            <div class="config-section">
                <h3>üìù Instrucciones:</h3>
                <ol>
                    <li>Abre tu Google Sheet</li>
                    <li>Ve a <strong>Extensiones ‚Üí Apps Script</strong></li>
                    <li>Pega el c√≥digo del script proporcionado</li>
                    <li>Haz clic en <strong>Implementar ‚Üí Nueva implementaci√≥n</strong></li>
                    <li>Selecciona <strong>Aplicaci√≥n web</strong></li>
                    <li>Copia la URL de la aplicaci√≥n web</li>
                    <li>P√©gala aqu√≠ abajo y guarda</li>
                </ol>
            </div>
            
            <div class="form-group">
                <label>URL del Web App de Google Apps Script:</label>
                <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/...">
            </div>
            
            <div class="actions">
                <button class="btn btn-success" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                <button class="btn btn-primary" onclick="testConnection()">üîå Probar Conexi√≥n</button>
                <button class="btn btn-primary" onclick="syncToCloud()">‚òÅÔ∏è Sincronizar Todo a la Nube</button>
                <button class="btn btn-primary" onclick="loadFromCloud()">‚¨áÔ∏è Cargar Datos desde la Nube</button>
            </div>
            
            <div id="configStatus"></div>

            <!-- NUEVA SECCI√ìN DE RESPALDO LOCAL -->
            <h2 style="margin-top: 40px;">üíæ Respaldo Local de Datos</h2>
            
            <div class="backup-section">
                <h3>üì¶ Gesti√≥n de Respaldos</h3>
                <p>Protege tu informaci√≥n exportando e importando respaldos locales en formato JSON</p>
                
                <div class="backup-info">
                    <p><strong>üìä Total de Alumnos:</strong> <span id="totalStudents">0</span></p>
                    <p><strong>üìù Total de Registros:</strong> <span id="totalRecords">0</span></p>
                    <p><strong>üïê √öltimo respaldo:</strong> <span id="lastBackup">Nunca</span></p>
                </div>

                <div class="actions">
                    <button class="btn btn-success" onclick="exportBackup()">üì• Descargar Respaldo Completo</button>
                    
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".json" onchange="importBackup(event)">
                        <label for="fileInput" class="file-input-label">üì§ Importar Respaldo desde Archivo</label>
                    </div>
                    
                    <button class="btn btn-warning" onclick="exportStudentsOnly()">üë• Exportar Solo Alumnos</button>
                    <button class="btn btn-warning" onclick="exportRecordsOnly()">üìä Exportar Solo Registros</button>
                </div>
            </div>

            <div id="backupStatus"></div>
        </div>
        
        <!-- TAB: ESC√ÅNER -->
        <div id="scanner" class="tab-content active">
            <div class="form-group">
                <label>Tipo de Registro:</label>
                <select id="recordType" onchange="focusScannerInput()">
                    <option value="entrada">Entrada</option>
                    <option value="salida">Salida</option>
                </select>
            </div>
            
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 15px; text-align: center; margin: 30px 0;">
                <h2 style="color: white; margin-bottom: 20px;">üîç Esc√°ner Bluetooth Activo</h2>
                <p style="color: white; font-size: 18px; margin-bottom: 20px;">Escanee el c√≥digo QR o c√≥digo de barras del alumno</p>
                
                <div class="form-group" style="max-width: 500px; margin: 0 auto;">
                    <input 
                        type="text" 
                        id="bluetoothScanner" 
                        placeholder="Campo listo para recibir c√≥digos..." 
                        style="font-size: 24px; text-align: center; padding: 20px; background: white; border: 3px solid #FFD700;"
                        autocomplete="off"
                        autofocus>
                </div>
                
                <p style="color: white; margin-top: 15px; opacity: 0.9;">
                    ‚ö° El c√≥digo se procesar√° autom√°ticamente despu√©s del escaneo
                </p>
            </div>
            
            <div id="statusMessage"></div>
            
            <div class="manual-entry">
                <h3>O bien, ingrese el c√≥digo manualmente</h3>
                <div class="form-group">
                    <label>C√≥digo del Alumno:</label>
                    <input type="text" id="manualCode" placeholder="Ingrese el c√≥digo y presione Enter">
                </div>
                <button class="btn btn-success" onclick="processManualCode()">‚úÖ Registrar</button>
            </div>
        </div>
        
        <!-- TAB: ALUMNOS -->
        <div id="students" class="tab-content">
            <h2>Gesti√≥n de Alumnos</h2>
            
            <div class="form-group">
                <label>Nombre del Alumno:</label>
                <input type="text" id="studentName" placeholder="Ej: Juan P√©rez">
            </div>
            
            <div class="form-group">
                <label>C√≥digo QR/Barras:</label>
                <input type="text" id="studentCode" placeholder="Ej: ALU001">
            </div>
            
            <div class="form-group">
                <label>Grado:</label>
                <input type="text" id="studentGrade" placeholder="Ej: 5to Grado">
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="addStudent()">‚ûï Agregar Alumno</button>
                <button class="btn btn-success" onclick="generateSampleStudents()">üé≤ Generar 30 Alumnos de Ejemplo</button>
            </div>
            
            <div id="studentsList" class="students-grid"></div>
        </div>
        
        <!-- TAB: REGISTROS -->
        <div id="records" class="tab-content">
            <h2>Registros de Asistencia</h2>
            
            <div class="form-group">
                <label>Filtrar por Fecha:</label>
                <input type="date" id="filterDate" onchange="filterRecords()">
            </div>
            
            <div class="actions">
                <button class="btn btn-success" onclick="exportToCSV()">üì• Exportar a Excel (CSV)</button>
                <button class="btn btn-danger" onclick="clearRecords()">üóëÔ∏è Limpiar Registros</button>
            </div>
            
            <div id="recordsTable"></div>
        </div>
        
        <!-- TAB: REPORTES -->
        <div id="reports" class="tab-content">
            <h2>Reportes y Estad√≠sticas</h2>
            
            <div class="form-group">
                <label>Seleccionar Semana:</label>
                <input type="week" id="weekSelect" onchange="generateWeeklyReport()">
            </div>
            
            <div class="stats-grid" id="statsGrid"></div>
            
            <div id="weeklyReport"></div>
        </div>
    </div>

    <script>
        // Estructura de datos
        let students = [];
        let attendanceRecords = [];
        let webAppUrl = '';
        let isCloudConnected = false;

        // Cargar datos al iniciar
        window.onload = function() {
            loadData();
            loadConfig();
            displayStudents();
            displayRecords();
            setTodayDate();
            setupBluetoothScanner();
            updateCloudStatus();
            updateBackupInfo();
        };

        // ========== NUEVAS FUNCIONES DE RESPALDO LOCAL ==========

        function updateBackupInfo() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalRecords').textContent = attendanceRecords.length;
            
            const lastBackup = localStorage.getItem('lastBackupDate');
            if (lastBackup) {
                const date = new Date(lastBackup);
                document.getElementById('lastBackup').textContent = date.toLocaleString('es-MX');
            } else {
                document.getElementById('lastBackup').textContent = 'Nunca';
            }
        }

        function exportBackup() {
            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                students: students,
                attendanceRecords: attendanceRecords,
                webAppUrl: webAppUrl
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            const filename = `respaldo_asistencia_${new Date().toISOString().split('T')[0]}.json`;
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.click();
            
            localStorage.setItem('lastBackupDate', new Date().toISOString());
            updateBackupInfo();
            showBackupStatus('‚úÖ Respaldo completo descargado exitosamente', 'success');
        }

        function exportStudentsOnly() {
            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                students: students
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            const filename = `alumnos_${new Date().toISOString().split('T')[0]}.json`;
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.click();
            
            showBackupStatus('‚úÖ Lista de alumnos descargada exitosamente', 'success');
        }

        function exportRecordsOnly() {
            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                attendanceRecords: attendanceRecords
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            const filename = `registros_${new Date().toISOString().split('T')[0]}.json`;
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.click();
            
            showBackupStatus('‚úÖ Registros descargados exitosamente', 'success');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validar estructura del archivo
                    if (!backupData.version) {
                        showBackupStatus('‚ùå Archivo inv√°lido: no es un respaldo v√°lido', 'error');
                        return;
                    }
                    
                    // Preguntar antes de sobrescribir
                    const hasData = students.length > 0 || attendanceRecords.length > 0;
                    if (hasData) {
                        const confirmImport = confirm(
                            '‚ö†Ô∏è ADVERTENCIA: Esto reemplazar√° todos los datos actuales.\n\n' +
                            `Datos actuales:\n` +
                            `- Alumnos: ${students.length}\n` +
                            `- Registros: ${attendanceRecords.length}\n\n` +
                            `Datos a importar:\n` +
                            `- Alumnos: ${backupData.students?.length || 0}\n` +
                            `- Registros: ${backupData.attendanceRecords?.length || 0}\n\n` +
                            '¬øDesea continuar?'
                        );
                        
                        if (!confirmImport) {
                            showBackupStatus('‚ùå Importaci√≥n cancelada', 'error');
                            event.target.value = '';
                            return;
                        }
                    }
                    
                    // Importar datos
                    if (backupData.students) {
                        students = backupData.students;
                    }
                    
                    if (backupData.attendanceRecords) {
                        attendanceRecords = backupData.attendanceRecords;
                    }
                    
                    if (backupData.webAppUrl) {
                        webAppUrl = backupData.webAppUrl;
                        localStorage.setItem('webAppUrl', webAppUrl);
                        document.getElementById('webAppUrl').value = webAppUrl;
                    }
                    
                    // Guardar en localStorage
                    saveData();
                    
                    // Actualizar vistas
                    displayStudents();
                    displayRecords();
                    updateBackupInfo();
                    
                    const studentsCount = backupData.students?.length || 0;
                    const recordsCount = backupData.attendanceRecords?.length || 0;
                    
                    showBackupStatus(
                        `‚úÖ Respaldo importado exitosamente\n` +
                        `üìä ${studentsCount} alumnos y ${recordsCount} registros restaurados`, 
                        'success'
                    );
                    
                } catch (error) {
                    showBackupStatus('‚ùå Error al leer el archivo: ' + error.message, 'error');
                }
                
                // Limpiar input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function showBackupStatus(message, type) {
            const statusDiv = document.getElementById('backupStatus');
            statusDiv.className = 'status-box ' + type;
            statusDiv.innerHTML = message.replace(/\n/g, '<br>');
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // ========== CONFIGURACI√ìN Y CONEXI√ìN A LA NUBE ==========
        
        function loadConfig() {
            webAppUrl = localStorage.getItem('webAppUrl') || '';
            if (webAppUrl) {
                document.getElementById('webAppUrl').value = webAppUrl;
                testConnection();
            }
        }

        function saveConfig() {
            webAppUrl = document.getElementById('webAppUrl').value.trim();
            if (!webAppUrl) {
                alert('Por favor ingrese una URL v√°lida');
                return;
            }
            localStorage.setItem('webAppUrl', webAppUrl);
            showConfigStatus('‚úÖ Configuraci√≥n guardada. Probando conexi√≥n...', 'success');
            testConnection();
        }

        async function testConnection() {
            if (!webAppUrl) {
                showConfigStatus('‚ùå Configure la URL del Web App primero', 'error');
                return;
            }
            
            showConfigStatus('üîÑ Probando conexi√≥n...', 'info');
            
            try {
                const response = await fetch(webAppUrl + '?action=getStudents');
                const data = await response.json();
                
                if (data.success) {
                    isCloudConnected = true;
                    showConfigStatus('‚úÖ Conexi√≥n exitosa con Google Sheets', 'success');
                    updateCloudStatus();
                } else {
                    isCloudConnected = false;
                    showConfigStatus('‚ùå Error al conectar: ' + data.error, 'error');
                    updateCloudStatus();
                }
            } catch (error) {
                isCloudConnected = false;
                showConfigStatus('‚ùå Error de conexi√≥n: ' + error.message, 'error');
                updateCloudStatus();
            }
        }

        function updateCloudStatus() {
            const statusDiv = document.getElementById('cloudStatus');
            if (isCloudConnected) {
                statusDiv.className = 'cloud-status';
                statusDiv.innerHTML = '‚úÖ Conectado a Google Sheets - Los datos se sincronizan autom√°ticamente';
            } else {
                statusDiv.className = 'cloud-status disconnected';
                statusDiv.innerHTML = '‚ö†Ô∏è No conectado a Google Sheets - Usando almacenamiento local';
            }
        }

        async function saveToCloud(endpoint, data) {
            if (!isCloudConnected || !webAppUrl) return false;
            
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Error guardando en la nube:', error);
                return false;
            }
        }

        async function syncToCloud() {
            if (!webAppUrl) {
                alert('Configure la URL del Web App primero');
                showTab('config');
                return;
            }
            
            showConfigStatus('üîÑ Sincronizando...', 'info');
            
            try {
                // Sincronizar alumnos
                await saveToCloud('saveStudents', {
                    action: 'saveStudents',
                    students: students
                });
                
                // Sincronizar registros (uno por uno)
                for (const record of attendanceRecords) {
                    await saveToCloud('saveRecord', {
                        action: 'saveRecord',
                        record: record
                    });
                }
                
                showConfigStatus('‚úÖ Sincronizaci√≥n completada', 'success');
            } catch (error) {
                showConfigStatus('‚ùå Error en sincronizaci√≥n: ' + error.message, 'error');
            }
        }

        async function loadFromCloud() {
            if (!webAppUrl) {
                alert('Configure la URL del Web App primero');
                showTab('config');
                return;
            }
            
            showConfigStatus('üîÑ Cargando desde la nube...', 'info');
            
            try {
                // Cargar alumnos
                const studentsResponse = await fetch(webAppUrl + '?action=getStudents');
                const studentsData = await studentsResponse.json();
                
                if (studentsData.success && studentsData.students.length > 0) {
                    students = studentsData.students;
                }
                
                // Cargar registros
                const recordsResponse = await fetch(webAppUrl + '?action=getRecords');
                const recordsData = await recordsResponse.json();
                
                if (recordsData.success && recordsData.records.length > 0) {
                    attendanceRecords = recordsData.records;
                }
                
                saveData();
                displayStudents();
                displayRecords();
                updateBackupInfo();
                
                showConfigStatus('‚úÖ Datos cargados desde la nube', 'success');
            } catch (error) {
                showConfigStatus('‚ùå Error cargando datos: ' + error.message, 'error');
            }
        }

        function showConfigStatus(message, type) {
            const statusDiv = document.getElementById('configStatus');
            statusDiv.className = 'status-box ' + type;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
        }

        // ========== FUNCIONES ORIGINALES ==========

        function setupBluetoothScanner() {
            const scannerInput = document.getElementById('bluetoothScanner');
            const manualInput = document.getElementById('manualCode');
            
            scannerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const code = scannerInput.value.trim();
                    if (code) {
                        processCode(code);
                        scannerInput.value = '';
                    }
                }
            });
            
            manualInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    processManualCode();
                }
            });
            
            setInterval(() => {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id === 'scanner') {
                    if (document.activeElement !== scannerInput && 
                        document.activeElement !== manualInput &&
                        document.activeElement.tagName !== 'SELECT') {
                        scannerInput.focus();
                    }
                }
            }, 500);
        }

        function focusScannerInput() {
            setTimeout(() => {
                document.getElementById('bluetoothScanner').focus();
            }, 100);
        }

        function loadData() {
            const storedStudents = localStorage.getItem('students');
            const storedRecords = localStorage.getItem('attendanceRecords');
            
            if (storedStudents) students = JSON.parse(storedStudents);
            if (storedRecords) attendanceRecords = JSON.parse(storedRecords);
        }

        function saveData() {
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            updateBackupInfo();
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'records') {
                displayRecords();
            } else if (tabName === 'reports') {
                generateWeeklyReport();
            } else if (tabName === 'scanner') {
                focusScannerInput();
            } else if (tabName === 'config') {
                updateBackupInfo();
            }
        }

        function processManualCode() {
            const code = document.getElementById('manualCode').value.trim();
            if (!code) {
                showStatus('Por favor ingrese un c√≥digo', 'error');
                return;
            }
            processCode(code);
            document.getElementById('manualCode').value = '';
        }

        async function processCode(code) {
            const student = students.find(s => s.code === code);
            
            if (!student) {
                showStatus('‚ùå Alumno no encontrado: ' + code, 'error');
                return;
            }
            
            const recordType = document.getElementById('recordType').value;
            const now = new Date();
            
            const record = {
                studentCode: code,
                studentName: student.name,
                type: recordType,
                date: now.toLocaleDateString('es-MX'),
                time: now.toLocaleTimeString('es-MX'),
                timestamp: now.getTime()
            };
            
            attendanceRecords.push(record);
            saveData();
            
            // Guardar en la nube
            if (isCloudConnected) {
                const cloudSuccess = await saveToCloud('saveRecord', {
                    action: 'saveRecord',
                    record: record
                });
                
                if (cloudSuccess) {
                    console.log('Registro guardado en la nube');
                }
            }
            
            const icon = recordType === 'entrada' ? 'üü¢' : 'üî¥';
            showStatus(`${icon} ${recordType.toUpperCase()} registrada: ${student.name} - ${record.time}`, 'success');
            
            setTimeout(() => {
                document.getElementById('bluetoothScanner').focus();
            }, 1500);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'status-box ' + type;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
        }

        async function addStudent() {
            const name = document.getElementById('studentName').value.trim();
            const code = document.getElementById('studentCode').value.trim();
            const grade = document.getElementById('studentGrade').value.trim();
            
            if (!name || !code) {
                alert('Por favor complete nombre y c√≥digo');
                return;
            }
            
            if (students.find(s => s.code === code)) {
                alert('Ya existe un alumno con ese c√≥digo');
                return;
            }
            
            students.push({ name, code, grade });
            saveData();
            
            // Guardar en la nube
            if (isCloudConnected) {
                await saveToCloud('saveStudents', {
                    action: 'saveStudents',
                    students: students
                });
            }
            
            document.getElementById('studentName').value = '';
            document.getElementById('studentCode').value = '';
            document.getElementById('studentGrade').value = '';
            
            displayStudents();
            alert('Alumno agregado exitosamente');
        }

        async function generateSampleStudents() {
            if (students.length > 0) {
                if (!confirm('Esto eliminar√° los alumnos actuales. ¬øContinuar?')) return;
            }
            
            students = [];
            const nombres = ['Juan', 'Mar√≠a', 'Pedro', 'Ana', 'Luis', 'Carmen', 'Jos√©', 'Laura', 'Carlos', 'Sof√≠a'];
            const apellidos = ['Garc√≠a', 'Rodr√≠guez', 'Mart√≠nez', 'L√≥pez', 'Gonz√°lez', 'P√©rez', 'S√°nchez', 'Ram√≠rez', 'Torres', 'Flores'];
            const grados = ['1ero A', '1ero B', '2do A', '2do B', '3ero A'];
            
            for (let i = 1; i <= 30; i++) {
                const nombre = nombres[Math.floor(Math.random() * nombres.length)];
                const apellido = apellidos[Math.floor(Math.random() * apellidos.length)];
                const grado = grados[Math.floor(Math.random() * grados.length)];
                
                students.push({
                    name: `${nombre} ${apellido} ${i}`,
                    code: `ALU${String(i).padStart(3, '0')}`,
                    grade: grado
                });
            }
            
            saveData();
            
            // Guardar en la nube
            if (isCloudConnected) {
                await saveToCloud('saveStudents', {
                    action: 'saveStudents',
                    students: students
                });
            }
            
            displayStudents();
            alert('30 alumnos generados exitosamente');
        }

        function displayStudents() {
            const container = document.getElementById('studentsList');
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No hay alumnos registrados</p>';
                return;
            }
            
            container.innerHTML = students.map((student, index) => `
                <div class="student-card">
                    <h3>${student.name}</h3>
                    <p><strong>C√≥digo:</strong> ${student.code}</p>
                    <p><strong>Grado:</strong> ${student.grade}</p>
                    <button class="btn btn-danger" onclick="deleteStudent(${index})" style="width: 100%; margin-top: 10px;">Eliminar</button>
                </div>
            `).join('');
        }

        async function deleteStudent(index) {
            if (confirm('¬øEliminar este alumno?')) {
                students.splice(index, 1);
                saveData();
                
                // Actualizar en la nube
                if (isCloudConnected) {
                    await saveToCloud('saveStudents', {
                        action: 'saveStudents',
                        students: students
                    });
                }
                
                displayStudents();
            }
        }

        function displayRecords() {
            const container = document.getElementById('recordsTable');
            const filterDate = document.getElementById('filterDate').value;
            
            let filtered = attendanceRecords;
            if (filterDate) {
                const filterDateObj = new Date(filterDate + 'T00:00:00');
                const filterDateStr = filterDateObj.toLocaleDateString('es-MX');
                filtered = attendanceRecords.filter(r => r.date === filterDateStr);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No hay registros para mostrar</p>';
                return;
            }
            
            const sortedRecords = [...filtered].sort((a, b) => b.timestamp - a.timestamp);
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Alumno</th>
                            <th>C√≥digo</th>
                            <th>Tipo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedRecords.map(record => `
                            <tr>
                                <td>${record.date}</td>
                                <td>${record.time}</td>
                                <td>${record.studentName}</td>
                                <td>${record.studentCode}</td>
                                <td><strong>${record.type === 'entrada' ? 'üü¢ ENTRADA' : 'üî¥ SALIDA'}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function filterRecords() {
            displayRecords();
        }

        function clearRecords() {
            if (confirm('¬øEst√° seguro de eliminar TODOS los registros?')) {
                attendanceRecords = [];
                saveData();
                displayRecords();
            }
        }

        function exportToCSV() {
            if (attendanceRecords.length === 0) {
                alert('No hay registros para exportar');
                return;
            }
            
            let csv = 'Fecha,Hora,Alumno,C√≥digo,Tipo\n';
            attendanceRecords.forEach(record => {
                csv += `${record.date},${record.time},${record.studentName},${record.studentCode},${record.type}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `asistencia_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
        }

        function generateWeeklyReport() {
            const weekInput = document.getElementById('weekSelect').value;
            
            if (!weekInput) {
                document.getElementById('weeklyReport').innerHTML = '<p style="text-align: center; color: #999;">Seleccione una semana para ver el reporte</p>';
                return;
            }
            
            const [year, week] = weekInput.split('-W');
            const weekStart = getDateOfISOWeek(parseInt(week), parseInt(year));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weekRecords = attendanceRecords.filter(record => {
                const recordDate = parseDate(record.date);
                return recordDate >= weekStart && recordDate <= weekEnd;
            });
            
            const totalRegistros = weekRecords.length;
            const totalEntradas = weekRecords.filter(r => r.type === 'entrada').length;
            const totalSalidas = weekRecords.filter(r => r.type === 'salida').length;
            const alumnosUnicos = new Set(weekRecords.map(r => r.studentCode)).size;
            
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <h3>${totalRegistros}</h3>
                    <p>Total de Registros</p>
                </div>
                <div class="stat-card">
                    <h3>${totalEntradas}</h3>
                    <p>Entradas</p>
                </div>
                <div class="stat-card">
                    <h3>${totalSalidas}</h3>
                    <p>Salidas</p>
                </div>
                <div class="stat-card">
                    <h3>${alumnosUnicos}</h3>
                    <p>Alumnos que Asistieron</p>
                </div>
            `;
            
            const studentStats = {};
            students.forEach(student => {
                const studentRecords = weekRecords.filter(r => r.studentCode === student.code);
                const entradas = studentRecords.filter(r => r.type === 'entrada');
                const diasAsistidos = new Set(entradas.map(r => r.date)).size;
                
                studentStats[student.code] = {
                    name: student.name,
                    diasAsistidos: diasAsistidos,
                    diasAusentes: 5 - diasAsistidos,
                    totalRegistros: studentRecords.length
                };
            });
            
            document.getElementById('weeklyReport').innerHTML = `
                <h3>Reporte Detallado por Alumno</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Alumno</th>
                            <th>C√≥digo</th>
                            <th>D√≠as Asistidos</th>
                            <th>D√≠as Ausentes</th>
                            <th>Total Registros</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(studentStats).map(([code, stats]) => `
                            <tr>
                                <td>${stats.name}</td>
                                <td>${code}</td>
                                <td>${stats.diasAsistidos}</td>
                                <td>${stats.diasAusentes}</td>
                                <td>${stats.totalRegistros}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function getDateOfISOWeek(week, year) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }

        function parseDate(dateString) {
            const parts = dateString.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
    </script>
</body>
</html>
